<!DOCTYPE html>
<html lang="fr">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>G5 Results</title>

    <!-- Bootstrap Core CSS -->
    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- Theme CSS -->
    <!--link href="css/grayscale.min.css" rel="stylesheet"-->
    <link href="css/grayscale.css" rel="stylesheet">
    
    <script src="/scripts/Chart.js"></script>
	<script src="/js/utils.js"></script>
	<script src="js/ws.js"></script>
    
    <style>
		canvas {
			-moz-user-select: none;
			-webkit-user-select: none;
			-ms-user-select: none;
		}
	</style>
	
	<script>

	    function connectToWS() {
        // Connect to websocket server
        ws = new WebSocket(wsServer);

        // Log messages from the server
        ws.onmessage = function (e) {
            console.log("| WS Received message: " + e.data);
            /*var reply = JSON.parse(e.data);
            if (reply.command == "nextvote") {
            	if(reply.vote != -1)
	                setvote(reply.vote);
            }//*/
        };

        // Log errors
        ws.onerror = function (error) {
            console.error("WebSocket Error " + error.stack);
        };

        ws.onopen = function (event) {
            console.log("- Connected to ws server");
            $.post("/iAmNewWheteTo",{}, function(data){
				/*if(data) {
					console.log("| Success sending iAmNewWheteTo");
					if(data == 13) {
						setvote(13);
					}
				}//*/
			});
        };
    }
    
    function readTextFile(file, callback) {
		var rawFile = new XMLHttpRequest();
		rawFile.overrideMimeType("application/json");
		rawFile.open("GET", file, true);
		rawFile.onreadystatechange = function() {
			if (rawFile.readyState === 4 && rawFile.status == "200") {
				callback(rawFile.responseText);
			}
		}
		rawFile.send(null);
	}

	var file = "/votes.json";
	var data;
	var ksize = 0;
	var curR = 0;
	var myRadar;
    
    var colorNames = Object.keys(window.chartColors);
	var color = Chart.helpers.color;

	var config = {
		type: 'bar',
		data: {
			labels: [],
			datasets: []
		},
		options: {
			legend: {
				display: false
			},
			title: {
				display: false
			}
		}
	};
	
	/*window.onload = function() {
		//config.options = optionsRadar;
		window.
	};//*/
							
	//usage:
	function loadVotes() {
		readTextFile(file, function(text){
			data = JSON.parse(text);
			ksize = Object.keys(data).length;
			console.log("- Loading "+file+" done : "+ksize+" results");	
		});
	}
	
	function prevRes() {
		curR = (curR - 1 >= 0 ? curR - 1 : 0);
		//console.log("PrevRes : "+curR+" - "+Object.keys(data)[curR]);
		loadRes(Object.keys(data)[curR]);
	}
	
    function nextRes() {
    	curR = (curR + 1 < ksize - 1 ? curR + 1 : ksize - 1);
		//console.log("NextRes : "+curR+" - "+Object.keys(data)[curR]);
		loadRes(Object.keys(data)[curR]);
	} 
    
    function loadRes(key) {
    	//console.log("loadRes : "+key+" "+curR);
    	//console.log(data[key]);
		config.data.labels.length = 0;
		config.data.datasets.length = 0;
		var colorName = colorNames[config.data.datasets.length % colorNames.length];
		var newColor = window.chartColors[colorName];
		var newDataset = {
			label: key,
			borderColor: newColor,
			backgroundColor: color(newColor).alpha(0.2).rgbString(),
			pointBackgroundColor: newColor,
			data: [],
		}
		
		var type = "none";
		var v = 0.;
		var t = '';
		
		Object.keys(data[key]).forEach(function(res){
			//console.log(res+" "+data[key][res]);
			if(res == "title") {
				document.getElementById("curR").value = key + " - " + data[key][res];
			} else if(res == "type") {
				type = data[key][res];
				v = 0.;
			} else {
				switch(type) {
					case "radar":
						config.type = 'bar';
						config.data.labels.push(res);
						newDataset.data.push(data[key][res]);
						break;
					case "radar2":
						if(res.indexOf("vote") != -1)
						{
							v = data[key][res];
						} else {
							config.type = 'bar';
							config.data.labels.push(res);
							newDataset.data.push(data[key][res]/v);
						}
						break;
					case "bar":
						config.type = 'bar';
						config.data.labels.push(res);
						newDataset.data.push(data[key][res]);
						break;
					case "bar2":
						if(res.indexOf("vote") != -1)
						{
							v = data[key][res];
						} else {
							config.type = 'bar';
							config.data.labels.push(res);
							newDataset.data.push(data[key][res]/v);
						}
						break;
				}
			}
		});
	
		config.data.datasets.push(newDataset);
		myRadar.update();
	};
    
    /* Onload */
    document.addEventListener("DOMContentLoaded", function(event) {

		myRadar = new Chart(document.getElementById('canvas'), config);

        connectToWS();
        
        loadVotes();

		setTimeout(function() {
			loadRes(Object.keys(data)[curR]);
			
		}, 1000);//*/

    });

	</script>
	
</head>

	<body id="page-top" data-spy="scroll" data-target=".navbar-fixed-top" style="">
		<!-- Navigation -->
    <nav class="navbar navbar-custom navbar-fixed-top" role="navigation" style="display:none">
    </nav>

    <!-- Section -->
    <section id="section-standBy" class="container content-section text-center" style="padding:20px;">
		<div style="width:100%">
			<canvas id="canvas"></canvas>
		</div>
		<input id="curR" type="text" class="btn btn-lg btn-click-look" style="width:600px; border:0px; text-align:center; color:gray;" disabled="disabled"/><br/>
		<button class="btn btn-lg btn-click-look" style="width:220px; text-align:center;" onclick="prevRes()">Previous Vote</button>
		<button class="btn btn-lg btn-click-look" style="width:220px; text-align:center;" onclick="nextRes()">Next Vote</button>
		<br/><button class="btn btn-lg btn-click-look" style="width:220px; text-align:center;" onclick="loadVotes(); ">Reload Votes</button>

	</section>
	
	<!-- jQuery -->
    <script src="vendor/jquery/jquery.js"></script>

    <!-- Plugin JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.3/jquery.easing.min.js"></script>

	</body>
</html>