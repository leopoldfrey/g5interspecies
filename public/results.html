<!DOCTYPE html>
<html lang="fr">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>G5 Results</title>

    <!-- Bootstrap Core CSS -->
    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- Theme CSS -->
    <!--link href="css/grayscale.min.css" rel="stylesheet"-->
    <link href="css/grayscale.css" rel="stylesheet">
    
    <script src="/scripts/Chart.min.js"></script>
	<script src="/js/utils.js"></script>
	<script src="js/ws.js"></script>
    
    <style>
		canvas {
			-moz-user-select: none;
			-webkit-user-select: none;
			-ms-user-select: none;
		}
	</style>
	
	<script>

	    function connectToWS() {
        // Connect to websocket server
        ws = new WebSocket(wsServer);

        // Log messages from the server
        ws.onmessage = function (e) {
            console.log("| WS Received message: " + e.data);
            /*var reply = JSON.parse(e.data);
            if (reply.command == "nextvote") {
            	if(reply.vote != -1)
	                setvote(reply.vote);
            }//*/
        };

        // Log errors
        ws.onerror = function (error) {
            console.error("WebSocket Error " + error.stack);
        };

        ws.onopen = function (event) {
            console.log("- Connected to ws server");
            $.post("/iAmNewWheteTo",{}, function(data){
				/*if(data) {
					console.log("| Success sending iAmNewWheteTo");
					if(data == 13) {
						setvote(13);
					}
				}//*/
			});
        };
    }
    
    function readTextFile(file, callback) {
		var rawFile = new XMLHttpRequest();
		rawFile.overrideMimeType("application/json");
		rawFile.open("GET", file, true);
		rawFile.onreadystatechange = function() {
			if (rawFile.readyState === 4 && rawFile.status == "200") {
				callback(rawFile.responseText);
			}
		}
		rawFile.send(null);
	}

	var file = "/votes.json";
	var data;
	var ksize = 0;
	var curR = 0;
    
    var colorNames = Object.keys(window.chartColors);
	var color = Chart.helpers.color;
	var config = {
		type: 'radar',
		data: {
			labels: [],
			datasets: []
		},
		options: {
			responsive: true,
			legend: {
				display: false,
				position: 'bottom',
			},
			title: {
				display: false,
				text: 'Chart.js Radar Chart'
			},
			scale: {
				display: true,
				ticks: {
					beginAtZero: true
				}
			}
		}
	};

	window.onload = function() {
		window.myRadar = new Chart(document.getElementById('canvas'), config);
	};
							
	//usage:
	function loadVotes() {
		readTextFile(file, function(text){
			data = JSON.parse(text);
			ksize = Object.keys(data).length;
			console.log("- Loading "+file+" done : "+ksize+" results");	
		});
	}
	
	function prevRes() {
		curR = (curR - 1 >= 0 ? curR - 1 : 0);
		//console.log("PrevRes : "+curR+" - "+Object.keys(data)[curR]);
		loadRes(Object.keys(data)[curR]);
	}
	
    function nextRes() {
    	curR = (curR + 1 < ksize - 1 ? curR + 1 : ksize - 1);
		//console.log("NextRes : "+curR+" - "+Object.keys(data)[curR]);
		loadRes(Object.keys(data)[curR]);
	} 
    
    function loadRes(key) {
    	//console.log("loadRes : "+key+" "+curR);
    	document.getElementById("curR").value = key;
		//console.log(data[key]);
		config.data.labels.length = 0;
		config.data.datasets.length = 0;
		var colorName = colorNames[config.data.datasets.length % colorNames.length];
		var newColor = window.chartColors[colorName];
		var newDataset = {
			label: key,
			borderColor: newColor,
			backgroundColor: color(newColor).alpha(0.2).rgbString(),
			pointBackgroundColor: newColor,
			data: [],
		}
		
		var type = "none";
		
		Object.keys(data[key]).forEach(function(res){
			//console.log(res+" "+data[key][res]);
			if(res == "type")
			{
				type = data[key][res];
			} else {
				switch(type) {
					case "radar":
						config.type = 'radar';
						//config.options.scale.display: true;
						config.data.labels.push(res);
						newDataset.data.push(data[key][res]);
						break;
					case "radar2":
						break;
					case "bar":
						config.type = 'bar';
						//config.options.scale.display: false;
						config.data.labels.push(res);
						newDataset.data.push(data[key][res]);
						break;
					case "bar2":
						break;
				}
			}
		});
	
		config.data.datasets.push(newDataset);
		window.myRadar.update();
	};
    
    /* Onload */
    document.addEventListener("DOMContentLoaded", function(event) {

        connectToWS();
        
        loadVotes();

		setTimeout(function() {
			loadRes(Object.keys(data)[curR]);
			
		}, 1000);//*/

    });

	</script>
	
</head>

	<body id="page-top" data-spy="scroll" data-target=".navbar-fixed-top" style="">
		<!-- Navigation -->
    <nav class="navbar navbar-custom navbar-fixed-top" role="navigation" style="display:none">
    </nav>

    <!-- Section -->
    <section id="section-standBy" class="container content-section text-center" style="padding:20px;">
		<div style="width:100%">
			<canvas id="canvas"></canvas>
		</div>
		<button class="btn btn-lg btn-click-look" style="width:220px; text-align:center;" onclick="prevRes()">Previous Vote</button>
		<input id="curR" type="text" class="btn btn-lg btn-click-look" style="width:220px; border:0px; text-align:center; color:gray;" disabled="disabled"/>
		<button class="btn btn-lg btn-click-look" style="width:220px; text-align:center;" onclick="nextRes()">Next Vote</button>
		<br/><button class="btn btn-lg btn-click-look" style="width:220px; text-align:center;" onclick="loadVotes(); ">Reload Votes</button>
		<!--button id="randomizeData">Randomize Data</button><br/>
		<button id="addDataset">Add Dataset</button><br/>
		<button id="removeDataset">Remove Dataset</button><br/>
		<button id="addData">Add Data</button><br/>
		<button id="removeData">Remove Data</button-->
		
		<script>
		    /*var randomScalingFactor = function() {
				return Math.round(Math.random() * 100);
			};

			document.getElementById('randomizeData').addEventListener('click', function() {
				config.data.datasets.forEach(function(dataset) {
					dataset.data = dataset.data.map(function() {
						return randomScalingFactor();
					});
				});

				window.myRadar.update();
			});

			var colorNames = Object.keys(window.chartColors);
			document.getElementById('addDataset').addEventListener('click', function() {
				var colorName = colorNames[config.data.datasets.length % colorNames.length];
				var newColor = window.chartColors[colorName];

				var newDataset = {
					label: 'Dataset ' + config.data.datasets.length,
					borderColor: newColor,
					backgroundColor: color(newColor).alpha(0.2).rgbString(),
					pointBackgroundColor: newColor,
					data: [],
				};

				for (var index = 0; index < config.data.labels.length; ++index) {
					newDataset.data.push(randomScalingFactor());
				}

				config.data.datasets.push(newDataset);
				window.myRadar.update();
			});

			document.getElementById('addData').addEventListener('click', function() {
				if (config.data.datasets.length > 0) {
					config.data.labels.push('dataset #' + config.data.labels.length);

					config.data.datasets.forEach(function(dataset) {
						dataset.data.push(randomScalingFactor());
					});

					window.myRadar.update();
				}
			});

			document.getElementById('removeDataset').addEventListener('click', function() {
				config.data.datasets.splice(0, 1);
				window.myRadar.update();
			});

			document.getElementById('removeData').addEventListener('click', function() {
				config.data.labels.pop(); // remove the label first

				config.data.datasets.forEach(function(dataset) {
					dataset.data.pop();
				});

				window.myRadar.update();
			});//*/
		</script>
		
		<!--input id="curV" type="text" class="btn btn-lg btn-click-look" style="width:220px; border:0px; text-align:center; color:gray;" disabled="disabled"/><br/>
		<button class="btn btn-lg btn-click-look" style="width:220px; text-align:center;" onclick="gotoVote(0)">Referendum</button><br/>
		<button class="btn btn-lg btn-click-look" style="width:220px; text-align:center;" onclick="sendPrevVote()">Previous Vote</button><br/>
		<button class="btn btn-lg btn-click-look" style="width:220px; text-align:center;" onclick="sendNextVote()">Next Vote</button><br/>
		<button class="btn btn-lg btn-click-look" style="width:220px; text-align:center;" onclick="gotoVote(13)">Future</button><br/>
		<br/>
		<br/>
		<button class="btn btn-lg btn-click-look" style="width:220px; text-align:center;" onclick="sendClearVotes()">Clear Votes</button><br/>
		<button class="btn btn-lg btn-click-look" style="width:220px; text-align:center;" onclick="sendClearGlobalVotes()">Clear Global Votes</button><br/>
		<button class="btn btn-lg btn-click-look" style="width:220px; text-align:center;" onclick="sendAddVotes()">Add Local To Global</button><br/>
		-->
	</section>
	
	<!-- jQuery -->
    <script src="vendor/jquery/jquery.js"></script>

    <!-- Plugin JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.3/jquery.easing.min.js"></script>

	</body>
</html>