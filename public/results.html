<!DOCTYPE html>
<html lang="fr">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>G5 Results</title>

    <!-- Bootstrap Core CSS -->
    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- Theme CSS -->
    <!--link href="css/grayscale.min.css" rel="stylesheet"-->
    <link href="css/grayscale.css" rel="stylesheet">
    
	<!-- Custom Fonts -->
    <link href="vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">

    <script src="/scripts/Chart.js"></script>
	<script src="/js/utils.js"></script>
	<script src="js/ws.js"></script>
    
    <style>
		canvas {
			-moz-user-select: none;
			-webkit-user-select: none;
			-ms-user-select: none;
		}
	</style>
	
	<script>

	    function connectToWS() {
        // Connect to websocket server
        ws = new WebSocket(wsServer);

        // Log messages from the server
        ws.onmessage = function (e) {
            console.log("| WS Received message: " + e.data);
            var reply = JSON.parse(e.data);
            if(reply.command == "sendOSC") {
            	console.log("| WS Received OSC message " + reply.address + ". Propagating to WS2");
            	//sendOSC(reply.address, reply.args);
            	if(reply.address == "/chart/prev") {
            		prevRes();
            	} else if(reply.address == "/chart/next") {
            		nextRes();
            	}
            }
        };

        // Log errors
        ws.onerror = function (error) {
            console.error("WebSocket Error " + error.stack);
        };

        ws.onopen = function (event) {
            console.log("- Connected to ws server");
            $.post("/iAmNewWheteTo",{}, function(data){
				/*if(data) {
					console.log("| Success sending iAmNewWheteTo");
					if(data == 13) {
						setvote(13);
					}
				}//*/
			});
        };
    }
    
    function readTextFile(file, callback) {
		var rawFile = new XMLHttpRequest();
		rawFile.overrideMimeType("application/json");
		rawFile.open("GET", file, true);
		rawFile.onreadystatechange = function() {
			if (rawFile.readyState === 4 && rawFile.status == "200") {
				callback(rawFile.responseText);
			}
		}
		rawFile.send(null);
	}

	var file = "/votes.json";
	var data;
	var ksize = 0;
	var curR = 0;
	var myRadar;
    
    var colorNames = Object.keys(window.chartColors);
	var color = Chart.helpers.color;

	Chart.defaults.global.defaultColor = 'white';
	Chart.defaults.global.defaultFontColor = 'white';
	Chart.defaults.global.defaultFontSize = 20;
	Chart.defaults.global.defaultFontFamily = 'Avenir Next';

	var config = {
		type: 'radar',
		data: {
			labels: [],
			datasets: []
		},
		options: {
			legend: {
				display: false
			},
			title: {
				display: false
			},
			scale: {
				ticks: {
            		beginAtZero: true,
            		callback: function() {return ""},
            		backdropColor: "rgba(0, 0, 0, 0)",
            		stepSize: 1
        		},
        		gridLines: {
        			color: "lightgray",
        		},
        		angleLines: {
        			color: "lightgray",
        		},
				pointLabels: {
      				color: "lightgray",
      				defaultFontStyle: "uppercase",
      				fontSize: 20
    			}
			}/*,
			scales: {
              xAxes: [{gridLines: { color: "#131c2b" }}],
              yAxes: [{gridLines: { color: "#131c2b" }}]
            }//*/
		}
	};
	
	function loadVotes() {
		readTextFile(file, function(text){
			data = JSON.parse(text);
			ksize = Object.keys(data).length;
			//console.log("- Loading "+file+" done : "+ksize+" results");
			loadRes(Object.keys(data)[curR]);
		});
	}
	
	function prevRes() {
		curR = (curR - 1 >= 0 ? curR - 1 : 0);
		loadRes(Object.keys(data)[curR]);
	}
	
    function nextRes() {
    	curR = (curR + 1 < ksize - 1 ? curR + 1 : ksize - 1);
		loadRes(Object.keys(data)[curR]);
	} 
    
    function loadRes(key) {
		config.data.labels.length = 0;
		config.data.datasets.length = 0;
		var colorName = colorNames[config.data.datasets.length % colorNames.length];
		var newColor = window.chartColors[colorName];
		var newDataset = {
			label: key,
			borderColor: newColor,
			backgroundColor: color(newColor).alpha(0.2).rgbString(),
			pointBackgroundColor: newColor,
			data: [],
		}
	
		var type = "none";
		var v = 0.;
		var t = '';
	
		Object.keys(data[key]).forEach(function(res){
			//console.log(res+" "+data[key][res]);
			if(res == "title") {
				document.getElementById("curR").innerHTML = key + " - " + data[key][res];
			} else if(res == "type") {
				type = data[key][res];
				v = 0.;
			} else {
				switch(type) {
					case "radar":
						config.type = 'radar';
						config.data.labels.push(res.toUpperCase());
						newDataset.data.push(data[key][res]);
						break;
					case "radar2":
						if(res.indexOf("vote") != -1)
						{
							v = data[key][res];
						} else {
							config.type = 'radar';
							config.data.labels.push(res.toUpperCase());
							newDataset.data.push(data[key][res]/v*2.-1.);
						}
						break;
					case "bar":
						config.type = 'bar';
						config.data.labels.push(res.toUpperCase());
						newDataset.data.push(data[key][res]);
						break;
					case "bar2":
						if(res.indexOf("vote") != -1)
						{
							v = data[key][res];
						} else {
							config.type = 'bar';
							config.data.labels.push(res.toUpperCase());
							//console.log("Value : "+res+" "+(data[key][res]/v*2.-1.));
							newDataset.data.push(data[key][res]/v*2.-1.);
						}
						break;
				}
			}
		});

		config.data.datasets.push(newDataset);
		myRadar.update(0);
	};
    
    /* Onload */
    document.addEventListener("DOMContentLoaded", function(event) {

		myRadar = new Chart(document.getElementById('canvas'), config);

        connectToWS();
        
        loadVotes();

		setInterval(loadVotes, 500);

    });

	</script>
	
</head>

	<body id="page-top" data-spy="scroll" data-target=".navbar-fixed-top" style="background-color: black;">
		<!-- Navigation -->
    <nav class="navbar navbar-custom navbar-fixed-top" role="navigation" style="display:none">
    </nav>

    <!-- Section -->
    <section id="section-standBy" class="container content-section text-center" style="padding:20px;">
		<h1 id="curR" style="margin-top:15px; margin-bottom: 25px; background-color:black; border:0px; text-align:center; color:lightgray;"></h1>
		<div id='divCanvas' style="width:100%">
			<canvas id="canvas"></canvas>
		</div>
		<!--
		<button class="btn btn-lg btn-click-look" style="width:220px; text-align:center; background-color: black; color: lightgray" onclick="prevRes()">Previous Vote</button>
		<button class="btn btn-lg btn-click-look" style="width:220px; text-align:center; background-color: black; color: lightgray" onclick="nextRes()">Next Vote</button>
		<button class="btn btn-lg btn-click-look" style="width:220px; text-align:center; background-color: black; color: lightgray" onclick="loadVotes(); ">Reload Votes</button>
		-->
	</section>
	
	<!-- jQuery -->
    <script src="vendor/jquery/jquery.js"></script>

    <!-- Plugin JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.3/jquery.easing.min.js"></script>

	</body>
</html>