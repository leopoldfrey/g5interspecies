<!DOCTYPE html>
<html lang="fr">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>G5 Interspecies</title>

    <!-- Bootstrap Core CSS -->
    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

	<!-- Custom Fonts -->
    <link href="vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">

    <!-- Theme CSS -->
    <!--link href="css/grayscale.min.css" rel="stylesheet"-->
    <link href="css/grayscale.css" rel="stylesheet">

    <!-- Img processing from phone -->
    <script src="js/load-image.all.min.js"></script>
    
    <style>
    .btn-click-look {
        background-color: white;
        color: gray;
        border: 1px solid lightgray;
        height: 40px;
        /*position: fixed;*/
        bottom: 40px;
        margin-right: auto;
        margin-left: auto;
        font-size: 15px;
        /*color: rgba(255, 255, 255, 0.2)*/
    }
    
    #msg-middle {
    	text-transform: none;
    }
    </style>
    
    <script>

	vote = 0;
		
	// WEBSOCKET CONNECTION	
    
	function sendMsg(_type, _message) {
		try {
		
			if(!ws)
				connectToWS();
				
			ws.send(
				JSON.stringify(
				{
					charset : 'utf8mb4', 
					type: _type,
					vote: _message
				})
			, function (err) {
				if (err) {
					console.log("- Error sending message "+err.stack);
				} else {
					console.log("- Success sending message "+ _type);
				}
			
			});
		} catch (err) {
			//alert(err.message);
			console.log("Error sending message : "+err.message);
			console.log(err.stack);
		}
	}

	function sendVote(_vote, _value) {

        $.post("/vote",{vote: _vote, value: _value}, function(data){
        	if(data==="ok") {
                console.log("- Success sending vote");
              }
          });

		//window.location.href = '/biosync.html?name=' + document.getElementById("name").value.replace(/ /g, "_");
    }
    
    function next() {
    	switch(vote){
    		case 0:
    			sendVote('A.I',document.querySelector('input[name="A.I"]:checked').value);
    			setvote(vote+1);
    			break;
    		case 1:
    			sendVote('A.II.1',document.querySelector('input[name="A.II.1"]:checked').value);
    			setvote(vote+1);
    			break;
    	}
    }

	var ws;
    //const port = location.PORT || 3000;
	//var wsServer = "ws://" + window.location.hostname + ":" + port;// + "/ws";
    var wsServer = "wss://" + window.location.hostname + "/wss";
    	
    /* -- Web Sockets -- */
    document.addEventListener("visibilitychange", function() {
        //console.log("Visibility changed to: " + document.visibilityState);
        if(document.visibilityState == "visible" ) {
            checkWSStateAndReconnectIfNecessary(ws.readyState);

            // Check again in one second
            setTimeout(function(){
                checkWSStateAndReconnectIfNecessary(ws.readyState);
            }, 3000);
        }
    });

    document.addEventListener("onfocus", function() {
        //console.log("Gained focus");
        checkWSStateAndReconnectIfNecessary(ws.readyState);

        // Check again in one second
        setTimeout(function(){
            checkWSStateAndReconnectIfNecessary(ws.readyState);
        }, 3000);
    });

    function connectToWS() {
        // Connect to websocket server
        ws = new WebSocket(wsServer);

        // Log messages from the server
        ws.onmessage = function (e) {
            console.log("| WS Received message: " + e.data);
            var reply = JSON.parse(e.data);
            if (reply.type == "changeState" || reply.type == "initState") {
                setvote(reply.vote);
            }
        };

        // Log errors
        ws.onerror = function (error) {
            console.error("WebSocket Error " + error.stack);
        };

        ws.onopen = function (event) {
            console.log("- Connected to ws server");
        };
    }

    function checkWSStateAndReconnectIfNecessary(wsReadyState) {
        switch(wsReadyState) {
            case ws.CONNECTING:
                console.log("- WebSocket Connecting...");
                break;
            case ws.OPEN:
                console.log("- WebSocket Open :)");
                break;
            case ws.CLOSING:
                console.log("- WebSocket Closing...");
                break;
            case ws.CLOSED:
                console.log("* WebSocket Closed :(");
                connectToWS();
                break;
        }
    }

    function setvote(_vote) {
		vote = _vote;
        switch(parseInt(vote)) {
            case 0:
                document.getElementById("section-top").style.display = "";
                document.getElementById("msg-top").innerHTML = "REFERENDUM<br/>A.I";
            	document.getElementById("section-middle").style.display = "";
                document.getElementById("msg-middle").innerHTML = "Which human political protocol would you propose ?"+
                "<br/><br/><table style='margin:auto'>"+
                "<tr><td><input type='radio' name='A.I' value='anarchy'/></td><td>Anarchy</td></tr>"+
                "<tr><td><input type='radio' name='A.I' value='democracy'/></td><td>Democracy</td></tr>"+
                "<tr><td><input type='radio' name='A.I' value='spirituality'/></td><td>Spirituality</td></tr>"+
                "<tr><td><input type='radio' name='A.I' value='totalitarism'/></td><td>Totalitarism</td></tr>"+
                "<tr><td><input type='radio' name='A.I' value='other''/></td><td>Other</td></tr>"+
                "</table>";
            	document.getElementById("section-bottom").style.display = "none";
                document.getElementById("msg-bottom").innerHTML = "bottom";
                document.getElementById("next-btn").style.display = "";
                break;
            case 1:
                document.getElementById("section-top").style.display = "";
                document.getElementById("msg-top").innerHTML = "REFERENDUM<br/>A.II.1";
            	document.getElementById("section-middle").style.display = "";
                document.getElementById("msg-middle").innerHTML = "What is a human ?"+
                "<br/>"+
                "<br/><input type='radio' name='A.II.1' value='only_intelligent'>the only form of intelligence on earth</input>"+
                "<br/><input type='radio' name='A.II.1' value='most_intelligent'>the most intelligent form on earth</input>"+
                "<br/><input type='radio' name='A.II.1' value='another_intelligent'>another form of intelligence on earth</input>"+
                "<br/><input type='radio' name='A.II.1' value='another_form'>another form of life among several others</input>"+
                "</div>";
            	document.getElementById("section-bottom").style.display = "none";
                document.getElementById("msg-bottom").innerHTML = "bottom";
                document.getElementById("next-btn").style.display = "";
                break;
        }
            
    }
    
    /* Onload */
    document.addEventListener("DOMContentLoaded", function(event) {

        // Buttons
        //document.getElementById("next-btn").onclick = onClick;
		
		connectToWS();
        
        setvote(0);
    });

    </script>

</head>

<body id="page-top" data-spy="scroll" data-target=".navbar-fixed-top">

    <!-- Navigation -->
    <nav class="navbar navbar-custom navbar-fixed-top" role="navigation" style="display:none">
    
    </nav>

    <!-- Section -->
    <section id="section-top" style="padding-top:30px" class="container content-section text-center" style="padding:0;">
        <h1><span id="msg-top"></span></h1>
    </section>

	<section id="section-middle" class="container content-section text-center" style="padding:0;">
        <h4><span id="msg-middle"></span></h4>
    </section>

    <section id="section-bottom" style="" class="container content-section text-center" style="padding:0;">
        <h2><span id="msg-bottom"></span></h2>
    </section>

	<br/>
	
	<section id="section-btn" class="container content-section text-center" style="padding:0;">
        <div id="next-btn" class="btn btn-lg btn-click-look" onclick="next();">NEXT</div>
    </section>

    <!-- jQuery -->
    <script src="vendor/jquery/jquery.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="vendor/bootstrap/js/bootstrap.min.js"></script>

    <!-- Plugin JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.3/jquery.easing.min.js"></script>

    <!-- Theme JavaScript -->
    <!--script src="js/grayscale.min.js"></script-->
    <script src="js/grayscale.js"></script>

</body>

</html>
